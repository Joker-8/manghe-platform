# 芒盒平台项目启动说明

## 1. 环境准备要求

### 1.1 操作系统要求
- **Windows**: Windows 10/11 (64位)
- **macOS**: macOS 11.0 及以上版本
- **Linux**: Ubuntu 20.04 LTS 或 CentOS 8 及以上版本

### 1.2 Node.js/npm 版本规范
- **Node.js**: v16.x LTS 或 v18.x LTS 版本
- **npm**: v8.x 或 v9.x 版本

检查当前版本命令：
```bash
node -v
npm -v
```

### 1.3 依赖安装命令

#### 1.3.1 全局依赖安装
```bash
# 安装 Yarn（可选，但推荐）
npm install -g yarn

# 安装 PM2（用于生产环境进程管理）
npm install -g pm2
```

#### 1.3.2 项目依赖安装

**前端依赖安装：**
```bash
cd frontend
npm install
# 或使用 yarn
yarn install
```

**后端依赖安装：**
```bash
cd backend
npm install
# 或使用 yarn
yarn install
```

### 1.4 配置文件设置

#### 1.4.1 后端环境变量配置

在 `backend` 目录下创建 `.env` 文件，内容如下：

```dotenv
# 服务器配置
PORT=3020
HOST=127.0.0.1

# 数据库配置
DB_TYPE=sqlite
DB_PATH=./data/manghe.db

# JWT 配置
JWT_SECRET=manghe_platform_jwt_secret_key_2025
JWT_EXPIRES_IN=7d

# 上传配置
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=5242880

# 日志配置
LOG_LEVEL=info
LOG_DIR=./logs

# 短信服务配置（可选）
SMS_API_KEY=your_sms_api_key
SMS_API_SECRET=your_sms_api_secret
```

**注意事项：**
- `JWT_SECRET` 必须修改为安全的随机字符串
- 确保 `data`、`uploads` 和 `logs` 目录存在且有写入权限

#### 1.4.2 前端环境变量配置

在 `frontend` 目录下创建 `.env` 和 `.env.development` 文件：

**`.env` 文件：**
```dotenv
# 基础环境变量
VITE_APP_NAME=芒盒平台
VITE_APP_VERSION=1.0.0
VITE_API_BASE_URL=http://localhost:3017/api
```

**`.env.development` 文件：**
```dotenv
# 开发环境配置
VITE_API_BASE_URL=http://localhost:3020/api
VITE_DEBUG=true
```

**`.env.production` 文件（生产环境使用）：**
```dotenv
# 生产环境配置
VITE_API_BASE_URL=http://your-production-api-url/api
VITE_DEBUG=false
```

## 2. 项目初始化流程

### 2.1 代码克隆

```bash
# 克隆项目代码
git clone https://your-repository-url/manghe-platform.git
cd manghe-platform
```

### 2.2 依赖安装验证

安装完成后，验证依赖是否正确安装：

```bash
# 前端验证
cd frontend
npm list --depth=0

# 后端验证
cd ../backend
npm list --depth=0
```

### 2.3 数据库初始化步骤

#### 2.3.1 创建必要目录
```bash
# Windows 系统（PowerShell）
cd manghe-platform
New-Item -ItemType Directory -Force -Path backend\data, backend\logs, backend\uploads

# macOS/Linux 系统
cd manghe-platform
mkdir -p backend/data backend/logs backend/uploads
```

#### 2.3.2 初始化数据库

SQLite 数据库会在首次运行后端服务时自动创建和初始化，包括：
- 数据表结构创建
- 索引构建
- 必要的初始配置

**重要提示：** 后端服务启动时会自动执行数据库初始化脚本，无需手动运行。

## 3. 开发环境启动步骤

### 3.1 本地服务器启动命令

#### 3.1.1 启动后端服务

1. **创建必要的目录**

   在启动后端服务前，确保已创建必要的数据、日志和上传目录：

   ```bash
   # Windows PowerShell
   New-Item -ItemType Directory -Force -Path backend\data, backend\logs, backend\uploads
   
   # macOS/Linux
   mkdir -p backend/data backend/logs backend/uploads
   ```

2. **进入后端目录**

   ```bash
   cd backend
   ```

3. **启动后端服务**

   开发环境下使用 `npm run dev` 命令启动服务：

   ```bash
   npm run dev
   ```

   或者直接运行 `node app.js` 启动：

   ```bash
   node app.js
   ```

   > **注意**：使用 `npm run dev` 会启用热重载功能，对开发更友好。

4. **检查启动状态**

   后端服务启动成功后，将在端口 3020 上运行。启动日志应显示：
  ```
  ✅ 芒盒后端服务成功运行在端口 3020
  ✅ 数据库初始化成功
  ✅ 简单进程监控已启动
  ```

5. **端口冲突处理**

   如果遇到端口冲突，系统会自动尝试使用备用端口。如果需要手动指定端口，可以修改 `.env` 文件中的 `PORT` 配置：

   ```dotenv
   PORT=3017  # 修改为其他未被占用的端口
   ```

   修改端口后，需要同步更新前端环境变量配置文件中的 `VITE_API_BASE_URL`。

#### 3.1.2 启动前端服务

```bash
cd frontend
# 开发模式启动（带热重载）
npm run dev
```

前端服务启动成功后，默认地址为：http://localhost:5174/
（注意：端口可能根据系统状态变化，以实际启动日志为准）

### 3.2 服务验证方法

#### 3.2.1 后端API验证

运行项目根目录下的连接测试脚本：

```bash
node test-api-connection.js
```

成功输出示例：
```
✅ 后端健康检查成功!
响应状态码: 200
响应数据: { status: 'OK', message: '芒盒后端服务运行正常' }
```

#### 3.2.2 前端页面验证

在浏览器中访问：http://localhost:5174/

### 3.3 热重载配置说明

#### 3.3.1 后端热重载

后端使用 `nodemon` 实现热重载，配置在 `package.json` 中：

```json
"scripts": {
  "dev": "nodemon app.js"
}
```

#### 3.3.2 前端热重载

前端通过 Vite 自动实现热重载，无需额外配置。

### 3.3 开发工具推荐及配置

#### 3.3.1 IDE 推荐
- **WebStorm**: 完整支持 Node.js 和 Vue 开发
- **VSCode**: 轻量级选择，配合插件使用

#### 3.3.2 VSCode 推荐插件
- Volar (Vue 3 支持)
- ESLint
- Prettier - Code formatter
- Node.js Extension Pack
- SQLite Viewer

## 4. 生产环境部署指南

### 4.1 构建命令

#### 4.1.1 前端构建

```bash
cd frontend
# 生产环境构建
npm run build
```

构建完成后，静态文件将生成在 `dist` 目录中。

#### 4.1.2 后端准备

```bash
cd backend
# 安装生产环境依赖（无 devDependencies）
npm install --production
```

### 4.2 服务器配置要求

#### 4.2.1 硬件要求
- CPU: 2核及以上
- 内存: 4GB及以上
- 硬盘: 50GB及以上可用空间

#### 4.2.2 软件要求
- Node.js v16.x LTS 或 v18.x LTS
- Nginx（用于静态文件服务和反向代理）
- PM2（用于进程管理）

### 4.3 部署流程

#### 4.3.1 使用 PM2 部署后端

```bash
cd backend
# 安装 PM2
npm install -g pm2

# 使用 PM2 启动后端服务
pm start

# 设置 PM2 开机自启
pm install -g pm2
pm run pm2:startup
```

**注意：** 如果 package.json 中没有相关脚本，请使用以下命令：
```bash
# 直接使用 PM2 启动
cd backend
npm install -g pm2
pm start

# 或手动管理
cd backend
npm install -g pm2
pm start

# 设置开机自启
cd backend
npm install -g pm2
npm start
npm install -g pm2
pm run pm2:startup
```

### 4.4 生产环境验证

1. **后端服务验证**
   ```bash
   curl -X GET http://your-domain.com/api/health
   ```
   成功响应：`{"status":"OK","message":"芒盒后端服务运行正常"}`
   
   **本地开发环境验证：**
   ```bash
   curl -X GET http://localhost:3017/api/health
   ```
   成功响应：`{"status":"OK","message":"芒盒后端服务运行正常"}`

2. **前端页面验证**
   在浏览器中访问：https://your-domain.com

#### 4.3.2 Nginx 配置

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 前端静态文件
    location / {
        root /path/to/manghe-platform/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # API 反向代理
    location /api {
        proxy_pass http://localhost:3020/api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 静态资源
    location /static {
        alias /path/to/manghe-platform/backend/public;
        expires 30d;
    }
}
```

#### 4.3.3 启动验证

成功启动后，可以通过以下方式验证：

1. **前端验证**：在浏览器中访问 http://localhost:5174
2. **后端验证**：访问 http://localhost:3020/api/health 检查API服务是否正常（注意：当前使用的是端口3020）
3. **数据库验证**：查看后端日志，确认数据库连接正常
4. **API连接测试**：运行根目录下的 `node test-api-connection.js` 脚本验证前后端通信

**完整的启动验证流程**：

```bash
# 1. 验证后端健康状态
curl -X GET http://localhost:3020/api/health
# 预期响应: {"status":"OK","message":"芒盒后端服务运行正常"}

# 2. 运行API连接测试脚本
node test-api-connection.js
# 预期输出应包含 "✅ 后端健康检查成功!"

# 3. 在浏览器中访问前端应用
# 访问 http://localhost:5173
```

#### 4.3.4 完整项目启动流程总结

以下是在本地开发环境中完整启动项目的步骤总结：

1. **环境准备**
   - 安装 Node.js (推荐 v16+) 和 npm
   - 克隆代码仓库

2. **后端准备与启动**
   - 创建必要目录：`data`、`logs`、`uploads`
   - 进入后端目录：`cd backend`
   - 安装依赖：`npm install`
   - 配置环境变量：检查 `.env` 文件
   - 启动后端服务：`node app.js`（推荐）或 `npm run dev`
   - 确认服务运行在端口 3020

3. **前端准备与启动**
   - 进入前端目录：`cd frontend`
   - 安装依赖：`npm install`
   - 配置环境变量：确保 `.env.development` 中的 `VITE_API_BASE_URL` 指向正确的后端端口
   - 启动前端服务：`npm run dev`
   - 访问 http://localhost:5174

4. **系统验证**
   - 运行 API 连接测试脚本
   - 检查数据库连接状态
   - 验证前端页面功能

如果遇到端口冲突，系统会自动尝试使用备用端口。当前配置中，前端环境变量已更新为使用后端备用端口3017。

#### 4.3.5 配置 HTTPS（可选）

使用 Let's Encrypt 获取免费 SSL 证书：

```bash
# 安装 Certbot
apt install certbot python3-certbot-nginx

# 获取并配置证书
certbot --nginx -d your-domain.com
```

### 4.4 安全注意事项

1. **环境变量安全**
   - 生产环境中使用强密钥
   - 不要在代码仓库中提交 `.env` 文件

2. **文件上传安全**
   - 限制上传文件类型和大小
   - 对上传文件进行病毒扫描

3. **API 安全**
   - 实施适当的认证和授权
   - 使用 HTTPS 加密传输
   - 实施请求频率限制

4. **数据库安全**
   - 定期备份数据库
   - 使用参数化查询防止 SQL 注入

## 5. 常见问题排查及解决方案

### 5.1 环境配置问题

#### 5.1.1 Node.js 版本不兼容

**症状**：依赖安装失败或启动报错

**解决方法**：
```bash
# 使用 nvm 管理 Node.js 版本
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
nvm install 16
nvm use 16
```

#### 5.1.2 端口占用问题

**症状**：启动服务时提示 "EADDRINUSE" 错误

**解决方法**：
```bash
# Windows
  netstat -ano | findstr :3020
  # 然后终止占用端口的进程
  
  # macOS/Linux
  lsof -i :3020
  # 然后终止占用端口的进程
  kill -9 <进程ID>
  ```
  
  **注意**：如果端口 3020 也被占用，可以在 `.env` 文件中修改 `PORT` 设置为其他未被占用的端口，并相应更新前端配置文件中的 `VITE_API_BASE_URL`。

### 5.2 依赖冲突问题

#### 5.2.1 依赖版本冲突

**症状**：安装依赖时出现警告或错误

**解决方法**：
```bash
# 清除 node_modules 和 package-lock.json
rm -rf node_modules package-lock.json
# 重新安装
npm install
```

#### 5.2.2 特定包安装失败

**症状**：特定包安装失败，如 node-sass

**解决方法**：
```bash
# 清除缓存
npm cache clean --force
# 使用管理员权限安装
# Windows
npm install node-sass --unsafe-perm --save-dev
# macOS/Linux
sudo npm install node-sass --unsafe-perm --save-dev
```

### 5.3 启动失败问题

#### 5.3.1 后端服务启动失败

**症状**：后端服务无法启动或启动后立即退出

**排查步骤**：
1. 检查日志文件：`backend/logs/app.log`
2. 确保 `.env` 文件配置正确
3. 检查数据库连接
4. 查看端口是否被占用

**常见解决方案**：
```bash
# 确保数据库目录存在
mkdir -p backend/data
# 检查环境变量
cat backend/.env
# 尝试直接运行查看错误信息
node backend/app.js
```

#### 5.3.2 前端服务启动失败

**症状**：前端构建失败或开发服务器启动失败

**排查步骤**：
1. 检查依赖是否正确安装
2. 检查 Vite 配置文件
3. 确保 Node.js 版本兼容

**常见解决方案**：
```bash
# 清除缓存
npm cache clean --force
# 重新安装依赖
rm -rf node_modules
npm install
# 尝试修复依赖
npm audit fix
```

### 5.4 API 连接问题

#### 5.4.1 前后端跨域问题

**症状**：API 请求失败，控制台显示 CORS 错误

**解决方法**：确保后端已配置 CORS 中间件，检查 `backend/middleware/cors.js`

#### 5.4.2 API 请求超时

**症状**：API 请求超时或无法连接

**排查步骤**：
1. 检查网络连接
2. 确认后端服务是否正在运行
3. 检查 API 地址配置是否正确

**解决方法**：
```bash
   # 检查后端服务状态
   cd backend
   npm run dev
   # 测试 API 是否正常响应
    curl http://localhost:3020/api/health
   ```

## 6. 系统测试与验证

### 6.1 运行系统测试

```bash
# 在项目根目录
node test-api-connection.js
```

### 6.2 功能验证

1. 访问前端页面：http://localhost:5174
2. 测试用户登录/注册功能
3. 测试商城浏览和开盒功能
4. 验证收藏馆 3D 展示功能
5. 测试社区互动功能

## 7. 性能优化建议

1. **前端优化**
   - 启用图片压缩
   - 配置路由懒加载
   - 使用 CDN 加速静态资源

2. **后端优化**
   - 使用连接池管理数据库连接
   - 配置适当的缓存策略
   - 实施 API 请求限流

3. **数据库优化**
   - 定期清理无用数据
   - 优化数据库查询
   - 建立适当的索引

## 8. 维护与更新

1. **定期备份**
   - 数据库备份
   - 配置文件备份

2. **日志管理**
   - 定期清理日志文件
   - 监控系统日志

3. **更新流程**
   - 先备份当前版本
   - 拉取最新代码
   - 更新依赖
   - 重启服务

## 9. 紧急联系方式

技术支持：[技术支持邮箱]

---

文档版本：v1.1.0
最后更新：2025年11月